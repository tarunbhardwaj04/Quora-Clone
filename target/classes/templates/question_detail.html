<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout}">

<head>
    <title>Question - Quora Clone</title>
</head>

<body>
    <div layout:fragment="content" class="bg-gray-50 min-h-screen py-8">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Main Content -->
                <div class="lg:col-span-8 space-y-6">

                    <!-- Question Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div id="questionLoader" class="flex justify-center py-4">
                            <i class="fa-solid fa-circle-notch fa-spin text-brand-600 text-2xl"></i>
                        </div>
                        <div id="questionContent" class="hidden">
                            <div class="flex items-center space-x-2 mb-3">
                                <span id="qTopic"
                                    class="px-2.5 py-0.5 rounded-full bg-blue-50 text-blue-600 text-xs font-semibold uppercase tracking-wide">Topic</span>
                                <span class="text-gray-400 text-sm">&bull;</span>
                                <span id="qDate" class="text-gray-500 text-sm">Date</span>
                            </div>

                            <h1 id="qTitle" class="text-2xl font-bold text-gray-900 mb-4 leading-tight">Question Title
                            </h1>

                            <div class="flex items-center space-x-3 mb-6">
                                <img id="qAvatar" src="" class="h-8 w-8 rounded-full bg-gray-200" alt="">
                                <div class="text-sm">
                                    <span class="text-gray-900 font-semibold" id="qAuthor">Author</span>
                                    <span class="text-gray-500 ml-1">asked</span>
                                </div>
                            </div>

                            <div id="qBody" class="prose prose-brand max-w-none text-gray-800 mb-6">
                                Question Body...
                            </div>

                            <div class="flex items-center justify-between border-t border-gray-100 pt-4">
                                <div class="flex space-x-4">
                                    <button onclick="toggleLike('QUESTION', questionId)"
                                        class="flex items-center space-x-1.5 text-gray-500 hover:text-brand-600 transition">
                                        <i class="fa-regular fa-thumbs-up text-lg"></i>
                                        <span id="qLikes" class="font-medium">0</span>
                                        <span class="hidden sm:inline">Upvotes</span>
                                    </button>
                                    <button onclick="document.getElementById('answerInput').focus()"
                                        class="flex items-center space-x-1.5 text-gray-500 hover:text-brand-600 transition">
                                        <i class="fa-regular fa-pen-to-square text-lg"></i>
                                        <span class="font-medium">Answer</span>
                                    </button>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600">
                                    <i class="fa-solid fa-share-nodes text-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Answer Input -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex space-x-4">
                            <img id="myAvatar" src="" class="h-10 w-10 rounded-full bg-gray-200 shadow-sm" alt="">
                            <div class="flex-1">
                                <textarea id="answerInput" rows="3"
                                    class="w-full border-gray-200 rounded-lg focus:ring-brand-500 focus:border-brand-500 resize-none text-base p-3"
                                    placeholder="Write your answer..."></textarea>
                                <div class="flex justify-end mt-2">
                                    <button onclick="submitAnswer()" class="btn-primary w-auto py-2 px-6 text-sm">Post
                                        Answer</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Answers List -->
                    <div id="answersContainer" class="space-y-4">
                        <!-- Answers will be injected here -->
                    </div>

                </div>

                <!-- Right Sidebar -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 sticky top-24">
                        <h3 class="font-bold text-gray-900 mb-4">Related Questions</h3>
                        <div class="space-y-4">
                            <div class="group cursor-pointer">
                                <h4
                                    class="text-sm font-medium text-gray-900 group-hover:text-brand-600 group-hover:underline leading-snug mb-1">
                                    How do I learn Java efficiently?</h4>
                                <span class="text-xs text-gray-500">24 answers</span>
                            </div>
                            <div class="border-t border-gray-100"></div>
                            <div class="group cursor-pointer">
                                <h4
                                    class="text-sm font-medium text-gray-900 group-hover:text-brand-600 group-hover:underline leading-snug mb-1">
                                    What are the best Spring Boot resources?</h4>
                                <span class="text-xs text-gray-500">12 answers</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Script -->
    <script layout:fragment="script">
        const pathParts = window.location.pathname.split('/');
        const questionId = pathParts[pathParts.length - 1]; // Get ID from URL /question/{id}

        let currentUser = null;

        // Auth Helper
        function getAuthHeaders() {
            const token = localStorage.getItem('jwt_token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = 'Bearer ' + token;
            return headers;
        }

        // --- Fetch & Render Question ---
        async function fetchQuestion() {
            try {
                const response = await fetch(`/api/question/${questionId}`, { headers: getAuthHeaders() });
                if (!response.ok) throw new Error("Failed to load question");
                const q = await response.json();
                renderQuestion(q);
            } catch (err) {
                console.error(err);
                document.getElementById('questionContent').innerHTML = `<div class="text-red-500">Error loading question.</div>`;
            }
        }

        function renderQuestion(q) {
            document.getElementById('questionLoader').classList.add('hidden');
            document.getElementById('questionContent').classList.remove('hidden');

            document.getElementById('qTitle').textContent = q.title;
            document.getElementById('qBody').textContent = q.body || "";
            document.getElementById('qTopic').textContent = q.topic ? q.topic.name : "General";
            document.getElementById('qDate').textContent = new Date(q.createdAt).toLocaleDateString();

            // Author
            const author = q.user ? (q.user.name || q.user.username) : "Anonymous";
            document.getElementById('qAuthor').textContent = author;
            document.getElementById('qAvatar').src = `https://ui-avatars.com/api/?name=${author}&background=random&size=128`;

            // Likes (Assuming q.like is a list)
            document.getElementById('qLikes').textContent = q.like ? q.like.length : 0;

            // Set Page Title
            document.title = `${q.title} - Quora Clone`;
        }

        // --- Fetch & Render Answers ---
        async function fetchAnswers() {
            // Need API endpoint for answers by QuestionID. Added in plan.
            try {
                const response = await fetch(`/api/answer/question/${questionId}`, { headers: getAuthHeaders() });
                if (!response.ok) return;
                const answers = await response.json();
                renderAnswers(answers);
            } catch (err) {
                console.error("Failed answers", err);
            }
        }

        function renderAnswers(answers) {
            const container = document.getElementById('answersContainer');
            container.innerHTML = `<h3 class="font-bold text-gray-900 px-1">${answers.length} Answers</h3>`;

            answers.forEach(a => {
                const authorStart = a.user ? (a.user.name || a.user.username) : "User";
                const avatar = `https://ui-avatars.com/api/?name=${authorStart}&background=random&size=64`;
                const date = new Date(a.createdAt).toLocaleDateString();
                const likeCount = a.likes ? a.likes.length : 0;

                const card = `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center space-x-3 mb-4">
                        <img src="${avatar}" class="h-10 w-10 rounded-full bg-gray-100" alt="">
                        <div>
                            <div class="font-bold text-gray-900 text-sm">${authorStart}</div>
                            <div class="text-xs text-gray-500">Answered ${date}</div>
                        </div>
                    </div>
                    
                    <div class="prose prose-sm max-w-none text-gray-800 mb-4">
                        ${a.content}
                    </div>

                    <div class="flex items-center space-x-6 border-t border-gray-50 pt-3">
                        <button onclick="toggleLike('ANSWER', '${a.id}', this)" class="flex items-center space-x-2 text-gray-500 hover:text-brand-600 transition group">
                            <i class="fa-regular fa-thumbs-up group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-medium"><span class="count">${likeCount}</span> Upvotes</span>
                        </button>
                        <button onclick="toggleComments('${a.id}')" class="flex items-center space-x-2 text-gray-500 hover:text-gray-900 transition">
                            <i class="fa-regular fa-comment"></i>
                            <span class="text-sm font-medium">Comments</span>
                        </button>
                    </div>

                    <!-- Comments Section -->
                    <div id="comments-${a.id}" class="hidden mt-4 pt-4 border-t border-gray-100 bg-gray-50/50 -mx-6 px-6 pb-2">
                        <div id="commentsList-${a.id}" class="space-y-3 mb-4">
                            <!-- Injected Comments -->
                            <div class="text-center text-sm text-gray-400 py-2"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading comments...</div>
                        </div>
                        <div class="flex space-x-3">
                            <input type="text" id="commentInput-${a.id}" class="flex-1 border-gray-200 rounded-full text-sm px-4 focus:ring-brand-500 focus:border-brand-500" placeholder="Add a comment...">
                            <button onclick="postComment('${a.id}')" class="text-brand-600 font-semibold text-sm hover:text-brand-700">Post</button>
                        </div>
                    </div>

                </div>`;
                container.innerHTML += card;
            });
        }

        // --- Actions: Answer ---
        async function submitAnswer() {
            const content = document.getElementById('answerInput').value;
            if (!content.trim()) return alert("Answer cannot be empty");

            // Needed: Current User ID.
            if (!currentUser || !currentUser.id) {
                // Try to get from token or profile API if not loaded
                // For now, let's assume backend parses User from Token Principal mostly, 
                // BUT AnswerDtoTOAnswerAdapter uses userId from body. 
                // We need to fetch current user first or update backend to use Principal.
                // Let's decode token for ID if simple, or fetch 'me'.
                if (!currentUser) {
                    await loadCurrentUser();
                }
            }

            try {
                const response = await fetch('/api/answer', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        content: content,
                        questionId: questionId,
                        userId: currentUser.id // Critical: Backend expects this
                    })
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert("Failed to post answer");
                }
            } catch (e) { console.error(e); }
        }

        // --- Actions: Like ---
        async function toggleLike(type, targetId, btnElement) {
            // Need current user ID
            if (!currentUser) await loadCurrentUser();

            const body = {
                targetId: targetId,
                contentType: type,
                userId: currentUser.id
            };

            try {
                const response = await fetch('/api/likes', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const text = await response.text();
                    // "Vote added. Current count: 5"
                    // Parse count roughly
                    const countMatch = text.match(/count: (\d+)/);
                    if (countMatch && btnElement) {
                        const countSpan = btnElement.querySelector('.count');
                        if (countSpan) countSpan.textContent = countMatch[1];
                        // If logic was perfect we'd toggle icon style (solid vs regular)
                    } else if (countMatch && type === 'QUESTION') { // Main q button
                        document.getElementById('qLikes').textContent = countMatch[1];
                    }
                }
            } catch (e) { console.error(e); }
        }

        // --- Actions: Comments ---
        function toggleComments(answerId) {
            const section = document.getElementById(`comments-${answerId}`);
            section.classList.toggle('hidden');
            if (!section.classList.contains('hidden')) {
                loadComments(answerId);
            }
        }

        async function loadComments(answerId) {
            const list = document.getElementById(`commentsList-${answerId}`);
            try {
                const res = await fetch(`/api/comments/${answerId}`, { headers: getAuthHeaders() });
                const comments = await res.json();

                if (comments.length === 0) {
                    list.innerHTML = `<div class="text-xs text-gray-400 italic">No comments yet.</div>`;
                    return;
                }

                list.innerHTML = comments.map(c => {
                    const author = c.createdBy ? (c.createdBy.name || c.createdBy.username) : "User";
                    return `
                    <div class="flex space-x-2 text-sm">
                        <span class="font-bold text-gray-900">${author}:</span>
                        <span class="text-gray-700">${c.comment}</span>
                    </div>`;
                }).join('');

            } catch (e) {
                list.innerHTML = `<div class="text-red-500 text-xs">Error loading comments</div>`;
            }
        }

        async function postComment(answerId) {
            const input = document.getElementById(`commentInput-${answerId}`);
            const text = input.value;
            if (!text.trim()) return;

            if (!currentUser) await loadCurrentUser();

            try {
                const res = await fetch('/api/comments', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        comment: text,
                        answerId: answerId,
                        userId: currentUser.id,
                        parentId: null // Nested not supported in UI yet
                    })
                });
                if (res.ok) {
                    input.value = '';
                    loadComments(answerId);
                }
            } catch (e) { console.error(e); }
        }


        // Global Helpers
        async function loadCurrentUser() {
            try {
                const res = await fetch('/api/user/me', { headers: getAuthHeaders() });
                currentUser = await res.json();
                // Update My Avatar
                document.getElementById('myAvatar').src = `https://ui-avatars.com/api/?name=${currentUser.name || currentUser.username}&background=random`;
            } catch (e) { console.error("Logged out?"); }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentUser();
            fetchQuestion();
            fetchAnswers();
        });

    </script>
</body>

</html>