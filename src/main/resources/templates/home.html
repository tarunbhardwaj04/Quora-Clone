<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout}">

<head>
    <title>Home - Quora Clone</title>
</head>

<body>
    <div layout:fragment="content" class="bg-gray-50 min-h-screen">

        <!-- Navbar handled by layout -->

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                <!-- Left Sidebar -->
                <div class="hidden lg:block lg:col-span-2 space-y-2">
                    <p class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Feeds</p>
                    <a href="#"
                        class="flex items-center px-3 py-2 bg-gray-100 text-brand-600 rounded-md font-medium text-sm transition">
                        <i class="fa-solid fa-fire mr-3 w-4"></i> Popular
                    </a>
                    <a href="#"
                        class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-md font-medium text-sm transition">
                        <i class="fa-solid fa-flask mr-3 w-4"></i> Science
                    </a>
                    <a href="#"
                        class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-md font-medium text-sm transition">
                        <i class="fa-solid fa-microchip mr-3 w-4"></i> Technology
                    </a>
                    <a href="#"
                        class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-md font-medium text-sm transition">
                        <i class="fa-solid fa-film mr-3 w-4"></i> Movies
                    </a>
                </div>

                <!-- Feed (Center) -->
                <div class="col-span-1 lg:col-span-7 space-y-6" id="questionsContainer">
                    <!-- Create Post Widget -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 cursor-text"
                        onclick="document.getElementById('askModal').classList.remove('hidden')">
                        <div class="flex items-center space-x-4">
                            <img id="feedAvatar" class="h-10 w-10 rounded-full"
                                src="https://ui-avatars.com/api/?name=User&background=random" alt="">
                            <div
                                class="flex-1 bg-gray-100 rounded-full px-4 py-2.5 text-gray-500 text-sm hover:bg-gray-200 transition">
                                What do you want to ask or share?
                            </div>
                        </div>
                    </div>

                    <!-- Loader -->
                    <div id="loader" class="flex justify-center p-4">
                        <i class="fa-solid fa-circle-notch fa-spin text-brand-600 text-2xl"></i>
                    </div>

                </div>

                <!-- Right Sidebar -->
                <div class="hidden lg:block lg:col-span-3 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                        <h3 class="font-bold text-gray-900 mb-4">Improve Your Feed</h3>
                        <div class="space-y-3">
                            <label class="flex items-start">
                                <input type="checkbox" class="mt-1 rounded text-brand-600 focus:ring-brand-500">
                                <span class="ml-2 text-sm text-gray-600">Visit your feed specifically to find new topics
                                    to follow.</span>
                            </label>
                            <label class="flex items-start">
                                <input type="checkbox" class="mt-1 rounded text-brand-600 focus:ring-brand-500">
                                <span class="ml-2 text-sm text-gray-600">Follow 5 more Spaces</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Ask Question Modal -->
        <div id="askModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"
                onclick="document.getElementById('askModal').classList.add('hidden')"></div>
            <div
                class="relative bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden animate-[scaleIn_0.2s_ease-out]">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <div class="flex space-x-6 text-sm font-semibold">
                        <button class="text-gray-900 border-b-2 border-brand-600 pb-4 -mb-4.5">Add Question</button>
                        <button class="text-gray-500 hover:text-gray-700 pb-4">Create Post</button>
                    </div>
                    <button onclick="document.getElementById('askModal').classList.add('hidden')"
                        class="text-gray-400 hover:text-gray-500">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="flex items-center space-x-3 mb-4">
                        <img id="modalAvatar" class="h-8 w-8 rounded-full"
                            src="https://ui-avatars.com/api/?name=User&background=random" alt="">
                        <div class="text-sm">
                            <span id="modalUsername" class="font-semibold text-gray-900">User</span> asked
                            <div
                                class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200 ml-2">
                                <i class="fa-solid fa-globe mr-1"></i> Public
                            </div>
                        </div>
                    </div>
                    <input type="text" id="newQuestionTitle"
                        class="w-full text-xl font-semibold placeholder-gray-400 border-none focus:ring-0 p-0 mb-3"
                        placeholder='Start your question with "What", "How", "Why", etc.'>

                    <textarea id="newQuestionBody" rows="3"
                        class="w-full text-base placeholder-gray-400 border-none focus:ring-0 p-0 resize-none mb-3"
                        placeholder="Optional: Include context or details..."></textarea>

                    <div class="flex items-center space-x-2">
                        <i class="fa-solid fa-tag text-gray-400 text-sm"></i>
                        <input type="text" id="newQuestionTopic"
                            class="text-sm placeholder-gray-400 border-b border-gray-200 focus:border-brand-500 focus:outline-none w-32 pb-1"
                            placeholder="Topic (e.g. Java)">
                    </div>

                </div>
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                    <button onclick="document.getElementById('askModal').classList.add('hidden')"
                        class="px-4 py-2 rounded-full text-gray-700 font-medium hover:bg-gray-200 transition">Cancel</button>
                    <button onclick="submitQuestion()"
                        class="px-4 py-2 rounded-full bg-brand-600 text-white font-medium hover:bg-brand-700 disabled:opacity-50 transition">Add
                        Question</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script layout:fragment="script">

        // --- API Client --- 
        function getAuthHeaders() {
            const token = localStorage.getItem('jwt_token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = 'Bearer ' + token;
            return headers;
        }

        async function fetchQuestions() {
            try {
                const response = await fetch('/api/question', { headers: getAuthHeaders() });
                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login'; // Force login if unauthenticated
                    return;
                }
                const page = await response.json();
                renderQuestions(page.content);
            } catch (err) {
                console.error("Failed to fetch questions", err);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function renderQuestions(questions) {
            const container = document.getElementById('questionsContainer');
            if (!questions || questions.length === 0) {
                container.innerHTML += `<div class="text-center p-8 text-gray-500">No questions found. Be the first to ask!</div>`;
                return;
            }

            questions.forEach(q => {
                const likeCount = q.like ? q.like.length : 0;

                const card = `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition duration-200">
                    <div class="flex items-start space-x-3">
                       <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-xs font-bold text-gray-900">${q.user ? (q.user.name || q.user.username) : 'User'}</span>
                                <span class="text-xs text-gray-500">&bull; Posted just now</span>
                                <div class="px-2 py-0.5 rounded-full bg-gray-100 text-xs text-brand-600 font-medium">${q.topic ? q.topic.name : 'General'}</div>
                            </div>
                            <a href="/question/${q.id}" class="text-lg font-bold text-gray-900 mb-2 leading-snug hover:text-brand-600 cursor-pointer block">
                                ${q.title}
                            </a>
                            <p class="text-gray-600 text-sm mb-4 line-clamp-3">${q.body || ''}</p>
                            
                            <!-- Actions -->
                            <div class="flex items-center justify-between">
                                <div class="flex space-x-4">
                                    <button onclick="toggleLike('${q.id}', this)" class="flex items-center space-x-1.5 bg-gray-50 px-3 py-1.5 rounded-full text-gray-500 hover:bg-gray-100 transition text-sm font-medium">
                                        <i class="fa-regular fa-thumbs-up"></i>
                                        <span class="count">${likeCount}</span>
                                        <span>Upvote</span>
                                    </button>
                                    <a href="/question/${q.id}" class="flex items-center space-x-1.5 bg-gray-50 px-3 py-1.5 rounded-full text-gray-500 hover:bg-gray-100 transition text-sm font-medium">
                                        <i class="fa-regular fa-comment"></i>
                                        <span>Answer</span>
                                    </a>
                                     <button class="flex items-center space-x-1.5 bg-gray-50 px-3 py-1.5 rounded-full text-gray-500 hover:bg-gray-100 transition text-sm font-medium">
                                        <i class="fa-solid fa-share"></i>
                                    </button>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600">
                                    <i class="fa-solid fa-ellipsis"></i>
                                </button>
                            </div>
                       </div>
                    </div>
                </div>`;
                container.innerHTML += card;
            });
        }

        async function toggleLike(questionId, btn) {
            // Re-using logic needs User ID. 
            // We can fetch 'me' once on load.
            if (!window.currentUser) {
                try {
                    const res = await fetch('/api/user/me', { headers: getAuthHeaders() });
                    window.currentUser = await res.json();
                } catch (e) { return; }
            }

            try {
                const response = await fetch('/api/likes', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        targetId: questionId,
                        contentType: 'QUESTION',
                        userId: window.currentUser.id
                    })
                });

                if (response.ok) {
                    const text = await response.text();
                    const countMatch = text.match(/count: (\d+)/);
                    if (countMatch) {
                        btn.querySelector('.count').textContent = countMatch[1];
                        btn.classList.add('text-brand-600', 'bg-brand-50'); // simple active state feedback
                    }
                }
            } catch (e) { console.error(e); }
        }

        // --- Question Logic ---
        async function submitQuestion() {
            const title = document.getElementById('newQuestionTitle').value;
            const body = document.getElementById('newQuestionBody').value;
            const topic = document.getElementById('newQuestionTopic').value;

            if (!title) {
                alert("Title is required");
                return;
            }

            try {
                const response = await fetch('/api/question', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        title: title,
                        body: body || "Asked via web",
                        topicName: topic || "General"
                    })
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const errorText = await response.text();
                    console.error("Server error:", errorText);
                    alert("Failed to post question: " + errorText);
                }
            } catch (err) {
                console.error(err);
                alert("Network error posting question");
            }
        }

        // --- Profile & UI Logic ---
        function initHomeUI() {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));

                    const payload = JSON.parse(jsonPayload);
                    const username = payload.sub || "User";

                    // Update Feed Avatar
                    const avatarUrl = `https://ui-avatars.com/api/?name=${username}&background=random&color=fff`;
                    const feedAvatar = document.getElementById('feedAvatar');
                    if (feedAvatar) feedAvatar.src = avatarUrl;

                    // Update Modal Avatar/Name
                    const modalAvatar = document.getElementById('modalAvatar');
                    const modalUsername = document.getElementById('modalUsername');
                    if (modalAvatar) modalAvatar.src = avatarUrl;
                    if (modalUsername) modalUsername.textContent = username;

                } catch (e) {
                    console.error("Error decoding token", e);
                }
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            fetchQuestions();
            initHomeUI();
        });

    </script>
</body>

</html>